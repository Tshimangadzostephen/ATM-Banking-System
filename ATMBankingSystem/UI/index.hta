<!DOCTYPE html>
<html>
<head>
    <title>ATM Banking System</title>
    <hta:application
        id="ATMApp"
        applicationname="ATM Banking System"
        border="thin"
        caption="yes"
        maximizebutton="yes"
        minimizebutton="yes"
        showintaskbar="yes"
        singleinstance="yes"
        sysmenu="yes"
        windowstate="maximize">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Left panel */
        #sidePanel {
            width: 280px;
            background: #2c2c2c;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        #logo {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .actionBtn {
            background: #0066cc;
            border: none;
            color: white;
            padding: 12px;
            margin: 6px 0;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .actionBtn:hover {
            background: #0088ff;
        }

        #logArea {
            flex: 1;
            background: #000;
            color: #0f0;
            font-size: 12px;
            padding: 5px;
            margin-top: 10px;
            overflow-y: auto;
            border: 1px solid #0f0;
            font-family: 'Courier New', monospace;
        }

        /* Right column */
        #atmScreen {
            flex: 1;
            background: #f0f0f0;
        }

        #stateFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .status-indicator {
            padding: 5px;
            margin: 10px 0;
            background: #333;
            border-radius: 3px;
            font-size: 11px;
            text-align: center;
        }
        
        .status-indicator.activex {
            background: #2e7d2e;
        }
        
        .status-indicator.simulation {
            background: #7d7d2e;
        }
    </style>

    <script type="text/javascript">
        //Globals
        var GrgApp = null;
        var GrgDataPool = null;
        var ATMControl = null;  // Main ActiveX control
        var currentState = '000';
        var logMessages = [];
        var usingActiveX = false;

        // Define GetWebCtrl immediately as a global function
        // This MUST be available before any iframe loads
        window.GetWebCtrl = function (name) {
            // Make sure controls exist
            if (!GrgApp || !GrgDataPool) {
                initControls();
            }

            if (name === "GrgApp") return GrgApp;
            if (name === "GrgDataPool") return GrgDataPool;
            if (name === "ATMControl") return ATMControl;
            return null;

        };

        //alert("HTA GetWebCtrl type: " + typeof window.GetWebCtrl);


        function initControls() {
            // Create real ActiveX controls
            try {
                //main ATM control
                ATMControl = new ActiveXObject("ATMBankingSystem.ATMControl");

                //GRG controls
                var testGrgApp = new ActiveXObject("ATMBankingSystem.GrgApp");
                var testGrgDataPool = new ActiveXObject("ATMBankingSystem.GrgDataPool");

                // If we get here, ActiveX is available
                if (ATMControl && testGrgApp && testGrgDataPool) {
                    log("ActiveX controls detected - using real controls");

                    // Initialize the main control
                    if (ATMControl.Initialize) {
                        ATMControl.Initialize();
                        log("ATM ActiveX Control initialized");
                    }

                    // Initialize GRG controls
                    if (testGrgApp.Init) {
                        testGrgApp.Init();
                        log("GrgApp ActiveX Control initialized");
                    }

                    // Create wrapper objects that match our interface
                    GrgApp = {
                        LogEvent: function (msg) {
                            log("[ActiveX] " + msg);
                            if (testGrgApp.LogEvent) {
                                testGrgApp.LogEvent(msg);
                            }
                        },
                        LoadState: function (st) {
                            if (testGrgApp.LoadState) {
                                testGrgApp.LoadState(st);
                            }
                            loadState(st);  // Also update our iframe
                        },
                        GetCurrentState: function () {
                            if (testGrgApp.GetCurrentState) {
                                return testGrgApp.GetCurrentState();
                            }
                            return currentState;
                        },
                        // Store reference to actual ActiveX object
                        activeXObject: testGrgApp
                    };

                    GrgDataPool = {
                        SetData: function (k, v) {
                            log("=== DIRECT CALL TEST ===");
                            log("Attempting to call SetData directly despite 'unknown' type...");

                            try {
                                // Try calling the method anyway
                                var result = testGrgDataPool.SetData(k, v);
                                log("SUCCESS: SetData returned " + result);
                                return result;
                            } catch (e) {
                                log("FAILED: " + e.message);
                                log("Error number: " + e.number);
                                log("Error description: " + (e.description || "none"));
                                throw e;
                            }
                        },
                        GetData: function (k) {
                            if (testGrgDataPool.GetData) {
                                return testGrgDataPool.GetData(k);
                            }
                            return null;
                        },
                        ClearData: function () {
                            log("ActiveX Data cleared");
                            if (testGrgDataPool.ClearData) {
                                return testGrgDataPool.ClearData();
                            }
                        },
                        // Store reference to actual ActiveX object
                        activeXObject: testGrgDataPool
                    };

                    usingActiveX = true;
                    updateStatusIndicator("ActiveX Mode");
                    return;
                }
            } catch (e) {
                log("ActiveX not available: " + e.message);
                log("Falling back to JavaScript simulation");
            }

            // Fall back to JavaScript simulation
            if (!GrgApp) {
                GrgApp = {
                    LogEvent: function (msg) {
                        log("[Simulation] " + msg);
                    },
                    LoadState: function (st) {
                        loadState(st);
                    },
                    GetCurrentState: function () {
                        return currentState;
                    }
                };
            }

            if (!GrgDataPool) {
                // Use a simple object instead of sessionStorage (not supported in HTA)
                var dataStore = {};

                GrgDataPool = {
                    SetData: function (k, v) {
                        dataStore[k] = v;
                        log("Simulation Data set: " + k + " = " + v);
                    },
                    GetData: function (k) {
                        return dataStore[k] || null;
                    },
                    ClearData: function () {
                        dataStore = {};
                        log("Simulation Data cleared");
                    }
                };
            }

            usingActiveX = false;
            updateStatusIndicator("Simulation Mode");
        }

        function updateStatusIndicator(status) {
            var indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.innerHTML = status;
                indicator.className = 'status-indicator ' +
                    (usingActiveX ? 'activex' : 'simulation');
            }
        }

        function log(msg) {
            var t = new Date().toLocaleTimeString();
            logMessages.push("[" + t + "] " + msg);
            if (logMessages.length > 50) logMessages.shift();

            var logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.innerHTML = logMessages.join('<br>');
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        function loadState(st) {
            currentState = st;
            var frame = document.getElementById('stateFrame');
            if (frame) {
                try {
                    // Always use the same path structure from index.hta's perspective
                    var statePath = './' + st + '/' + st + '.html';

                    // Set src directly - this always works from parent's perspective
                    frame.src = statePath;
                    log("Loading state " + st);

                    // After frame loads, inject controls
                    frame.onload = frame.onreadystatechange = function () {
                        try {
                            if (frame.contentWindow) {
                                frame.contentWindow.GetWebCtrl = window.GetWebCtrl;
                                frame.contentWindow.parentWindow = window;
                            }
                        } catch (e) {
                            // Ignore errors
                        }
                    };
                } catch (e) {
                    log("Error loading state: " + e.message);
                }
            }
        }

        function insertTestCard() {
            if (!GrgDataPool) initControls();

            try {

                // If using ActiveX with main control, try its methods
                if (usingActiveX && ATMControl && ATMControl.InsertCard) {

                    try {

                        ATMControl.InsertCard("4532123456789012");
                        log("Test card inserted via ActiveX");
                    } catch (e) {
                        // If InsertCard fails, fall back to SetData
                        log("InsertCard failed, using SetData: " + e.message);
                        if (GrgDataPool && GrgDataPool.SetData) {
                            GrgDataPool.SetData("CardNumber", "4532123456789012");
                            GrgDataPool.SetData("CardholderName", "JOHN DOE");
                            GrgDataPool.SetData("ExpiryDate", "12/25");
                        }
                    }
                } else {
                    // Use GrgDataPool method
                    if (GrgDataPool && GrgDataPool.SetData) {
                        GrgDataPool.SetData("CardNumber", "4532123456789012");
                        GrgDataPool.SetData("CardholderName", "JOHN DOE");
                        GrgDataPool.SetData("ExpiryDate", "12/25");
                    }
                    log("Test card inserted");
                }
            } catch (e) {
                log("Error inserting test card: " + e.message);
            }

            loadState('136');
        }

        function resetSystem() {
            if (usingActiveX && ATMControl && ATMControl.Initialize) {
                ATMControl.Initialize();
                log("System reset via ActiveX");
            } else if (GrgDataPool) {
                GrgDataPool.ClearData();
                log("System reset");
            }
            loadState('000');
        }

        function testActiveX() {
            var msg = "ActiveX Status:\n\n";
            msg += "Using ActiveX: " + (usingActiveX ? "Yes" : "No") + "\n";

            if (usingActiveX) {
                msg += "\nActiveX Controls Loaded:\n";
                msg += "- ATMControl: " + (ATMControl ? "Yes" : "No") + "\n";
                msg += "- GrgApp: " + (GrgApp && GrgApp.activeXObject ? "Yes" : "No") + "\n";
                msg += "- GrgDataPool: " + (GrgDataPool && GrgDataPool.activeXObject ? "Yes" : "No") + "\n";

                if (ATMControl) {
                    try {
                        msg += "\nATMControl Methods:\n";
                        msg += "- GetVersion: " + (ATMControl.GetVersion ? ATMControl.GetVersion() : "N/A") + "\n";
                        msg += "- GetCurrentState: " + (ATMControl.GetCurrentState ? ATMControl.GetCurrentState() : "N/A") + "\n";
                    } catch (e) {
                        msg += "\nError accessing ATMControl: " + e.message;
                    }
                }
            } else {
                msg += "\nActiveX controls not available.\n";
                msg += "Running in JavaScript simulation mode.\n";
                msg += "\nTo use ActiveX:\n";
                msg += "1. Build the C# projects\n";
                msg += "2. Register DLLs with: regasm /codebase\n";
                msg += "3. Restart this application\n";
            }

            alert(msg);
        }
    </script>
</head>
<body>
    <div id="container">
        <!-- Left column -->
        <div id="sidePanel">
            <div id="logo">🏦 Universal Bank ATM</div>
            
            <div id="statusIndicator" class="status-indicator">Initializing...</div>
            
            <button class="actionBtn" onclick="insertTestCard()">Insert Card</button>
            <button class="actionBtn" onclick="resetSystem()">Reset System</button>
            <button class="actionBtn" onclick="loadState('000')">Back to Idle</button>
            <button class="actionBtn" onclick="testActiveX()">Test ActiveX</button>

            <div style="margin-top: 20px; font-size: 12px;">
                <div>Test PIN: 1234</div>
                <div>Card: 4532123456789012</div>
            </div>

            <div id="logArea"></div>
        </div>

        <!-- Right column: the ATM screen -->
        <div id="atmScreen">
            <iframe id="stateFrame" name="stateFrame"></iframe>
        </div>
    </div>

    <script type="text/javascript">
        // Initialize AFTER page loads
        window.onload = function () {
            // Initialize controls first
            initControls();

            // Set up frame communication using a different method
            var frame = document.getElementById('stateFrame');
            if (frame) {
                // For HTA, inject controls directly into frame's window object
                frame.onload = frame.onreadystatechange = function () {
                    try {
                        if (frame.contentWindow) {
                            // Inject GetWebCtrl function into frame
                            frame.contentWindow.GetWebCtrl = window.GetWebCtrl;
                            // Also inject parent reference
                            frame.contentWindow.parentWindow = window;
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                };
            }

            // Give it a moment to settle, then load initial state
            setTimeout(function () {
                loadState('000');
            }, 100);
        };
    </script>
</body>
</html>