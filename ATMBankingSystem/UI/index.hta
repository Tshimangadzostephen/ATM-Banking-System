<!DOCTYPE html>
<html>
<head>
    <title>ATM Banking System</title>
    <hta:application
        id="ATMApp"
        applicationname="ATM Banking System"
        border="thin"
        caption="yes"
        maximizebutton="yes"
        minimizebutton="yes"
        showintaskbar="yes"
        singleinstance="yes"
        sysmenu="yes"
        windowstate="maximize">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Left panel */
        #sidePanel {
            width: 280px;
            background: #2c2c2c;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        #logo {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .actionBtn {
            background: #0066cc;
            border: none;
            color: white;
            padding: 12px;
            margin: 6px 0;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .actionBtn:hover {
            background: #0088ff;
        }

        .actionBtn.secondary {
            background: #666;
        }

        .actionBtn.secondary:hover {
            background: #888;
        }

        #logArea {
            flex: 1;
            background: #000;
            color: #0f0;
            font-size: 12px;
            padding: 5px;
            margin-top: 10px;
            overflow-y: auto;
            border: 1px solid #0f0;
            font-family: 'Courier New', monospace;
        }

        /* Right column */
        #atmScreen {
            flex: 1;
            background: #f0f0f0;
        }

        #stateFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .status-indicator {
            padding: 5px;
            margin: 10px 0;
            background: #333;
            border-radius: 3px;
            font-size: 11px;
            text-align: center;
        }
        
        .status-indicator.activex {
            background: #2e7d2e;
        }
        
        .status-indicator.simulation {
            background: #7d7d2e;
        }

        .card-info {
            background: #333;
            padding: 8px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 11px;
        }
    </style>

    <script type="text/javascript">
        //Globals
        var GrgApp = null;
        var GrgDataPool = null;
        var ATMControl = null;
        var currentState = '000';
        var logMessages = [];
        var usingActiveX = false;

        // Card database - you can easily add more cards here
        var testCards = [
            {
                number: "4532123456789012",
                holder: "JOHN DOE",
                expiry: "12/25",
                pin: "1234",
                balance: 1500.00,
                name: "John's Visa"
            },
            {
                number: "5555666677778888",
                holder: "JANE SMITH",
                expiry: "06/26",
                pin: "5678",
                balance: 2500.00,
                name: "Jane's Mastercard"
            },
            {
                number: "4111111111111111",
                holder: "BOB JOHNSON",
                expiry: "03/27",
                pin: "9876",
                balance: 750.00,
                name: "Bob's Test Card"
            }
        ];

        var currentCardIndex = 0;

        // Define GetWebCtrl immediately as a global function
        window.GetWebCtrl = function (name) {
            if (!GrgApp || !GrgDataPool) {
                initControls();
            }

            if (name === "GrgApp") return GrgApp;
            if (name === "GrgDataPool") return GrgDataPool;
            if (name === "ATMControl") return ATMControl;
            return null;
        };

        function initControls() {
            // Create real ActiveX controls
            try {
                ATMControl = new ActiveXObject("ATMBankingSystem.ATMControl");
                var testGrgApp = new ActiveXObject("ATMBankingSystem.GrgApp");
                var testGrgDataPool = new ActiveXObject("ATMBankingSystem.GrgDataPool");

                if (ATMControl && testGrgApp && testGrgDataPool) {
                    log("ActiveX controls detected - using real controls");

                    // Initialize controls
                    try {
                        ATMControl.Initialize();
                        log("ATM ActiveX Control initialized");
                    } catch (e) {
                        log("Error initializing ATMControl: " + e.message);
                    }

                    try {
                        testGrgApp.Init();
                        log("GrgApp ActiveX Control initialized");
                    } catch (e) {
                        log("Error initializing GrgApp: " + e.message);
                    }

                    // Create wrapper objects with direct calls
                    GrgApp = {
                        LogEvent: function (msg) {
                            log("[ActiveX] " + msg);
                            try {
                                testGrgApp.LogEvent(msg);
                            } catch (e) {
                                log("LogEvent error: " + e.message);
                            }
                        },
                        LoadState: function (st) {
                            try {
                                testGrgApp.LoadState(st);
                            } catch (e) {
                                log("LoadState error: " + e.message);
                            }
                            loadState(st);
                        },
                        GetCurrentState: function () {
                            try {
                                return testGrgApp.GetCurrentState();
                            } catch (e) {
                                log("GetCurrentState error: " + e.message);
                                return currentState;
                            }
                        },
                        activeXObject: testGrgApp
                    };

                    GrgDataPool = {
                        SetData: function (k, v) {
                            try {
                                log("ActiveX SetData: " + k + " = " + v);
                                return testGrgDataPool.SetData(k, v);
                            } catch (e) {
                                log("SetData error: " + e.message);
                                throw e;
                            }
                        },
                        GetData: function (k) {
                            try {
                                return testGrgDataPool.GetData(k);
                            } catch (e) {
                                log("GetData error: " + e.message);
                                return null;
                            }
                        },
                        ClearData: function () {
                            try {
                                log("ActiveX ClearData called");
                                return testGrgDataPool.ClearData();
                            } catch (e) {
                                log("ClearData error: " + e.message);
                                return -1;
                            }
                        },
                        activeXObject: testGrgDataPool
                    };

                    usingActiveX = true;
                    updateStatusIndicator("ActiveX Mode");
                    return;
                }
            } catch (e) {
                log("ActiveX not available: " + e.message);
                log("Falling back to JavaScript simulation");
            }

            // Fall back to JavaScript simulation
            if (!GrgApp) {
                GrgApp = {
                    LogEvent: function (msg) {
                        log("[Simulation] " + msg);
                    },
                    LoadState: function (st) {
                        loadState(st);
                    },
                    GetCurrentState: function () {
                        return currentState;
                    }
                };
            }

            if (!GrgDataPool) {
                var dataStore = {};

                GrgDataPool = {
                    SetData: function (k, v) {
                        dataStore[k] = v;
                        log("Simulation Data set: " + k + " = " + v);
                        return 0;
                    },
                    GetData: function (k) {
                        return dataStore[k] || null;
                    },
                    ClearData: function () {
                        dataStore = {};
                        log("Simulation Data cleared");
                        return 0;
                    }
                };
            }

            usingActiveX = false;
            updateStatusIndicator("Simulation Mode");
        }

        function insertTestCard() {
            if (!GrgDataPool) initControls();
            try {
                var card = testCards[currentCardIndex];
                //log("Inserting " + card.name + " (****" + card.number.substring(12) + ")");

                if (usingActiveX && ATMControl) {
                    try {
                        log("ATMControl.InsertCard type: " + typeof ATMControl.InsertCard);
                        //alert("About to call ATMControl.InsertCard()");

                        var result = ATMControl.InsertCard(card.number);

                        //alert("ATMControl.InsertCard returned: " + result);
                        log("ATMControl.InsertCard succeeded, returned: " + result);

                        // Test if we can retrieve the card from ATMControl
                        var retrievedCard = ATMControl.GetCardNumber();
                        log("Retrieved from ATMControl: " + retrievedCard);

                    } catch (e) {
                        //alert("ATMControl.InsertCard failed: " + e.message);
                        log("ATMControl.InsertCard failed: " + e.message);
                    }
                }

                // Also set in GrgDataPool as backup
                insertCardData(card);

                loadState('136');
            } catch (e) {
                log("Error inserting test card: " + e.message);
                alert("Error inserting card: " + e.message);
            }
        }
        function insertCardData(card) {
            try {

                try {
                    GrgDataPool.SetData("CardNumber", card.number);
                } catch (e) {
                    throw e;
                }

                try {
                    GrgDataPool.SetData("CardholderName", card.holder);
                } catch (e) {
                    throw e;
                }

                try {
                    GrgDataPool.SetData("ExpiryDate", card.expiry);
                } catch (e) {
                    throw e;
                }
                // Test retrieval
                var storedCard = GrgDataPool.GetData("CardNumber");

            } catch (e) {
                log("ERROR storing card data: " + e.message);
                throw e;
            }
        }

        function switchTestCard() {
            currentCardIndex = (currentCardIndex + 1) % testCards.length;
            var card = testCards[currentCardIndex];

            log("Switched to " + card.name + " (****" + card.number.substring(12) + ")");
            updateCardDisplay();
        }

        function updateCardDisplay() {
            var card = testCards[currentCardIndex];
            var cardInfo = document.getElementById('cardInfo');
            if (cardInfo) {
                cardInfo.innerHTML =
                    '<div><strong>' + card.name + '</strong></div>' +
                    '<div>Card: ****' + card.number.substring(12) + '</div>' +
                    '<div>PIN: ' + card.pin + '</div>' +
                    '<div>Balance: R' + card.balance.toFixed(2) + '</div>';
            }
        }

        function updateStatusIndicator(status) {
            var indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.innerHTML = status;
                indicator.className = 'status-indicator ' +
                    (usingActiveX ? 'activex' : 'simulation');
            }
        }

        function log(msg) {
            var t = new Date().toLocaleTimeString();
            logMessages.push("[" + t + "] " + msg);
            if (logMessages.length > 50) logMessages.shift();

            var logArea = document.getElementById('logArea');
            if (logArea) {
                logArea.innerHTML = logMessages.join('<br>');
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        function loadState(st) {
            currentState = st;
            var frame = document.getElementById('stateFrame');
            if (frame) {
                try {
                    var statePath = './' + st + '/' + st + '.html';
                    frame.src = statePath;
                    log("Loading state " + st);

                    frame.onload = frame.onreadystatechange = function () {
                        try {
                            if (frame.contentWindow) {
                                frame.contentWindow.GetWebCtrl = window.GetWebCtrl;
                                frame.contentWindow.parentWindow = window;
                            }
                        } catch (e) {
                            // Ignore errors
                        }
                    };
                } catch (e) {
                    log("Error loading state: " + e.message);
                }
            }
        }

        function resetSystem() {
            try {
                if (usingActiveX && ATMControl) {
                    ATMControl.Initialize();
                    log("System reset via ActiveX");
                } else if (GrgDataPool) {
                    GrgDataPool.ClearData();
                    log("System reset");
                }
                loadState('000');
            } catch (e) {
                log("Error resetting system: " + e.message);
            }
        }

        function testActiveX() {
            var msg = "ActiveX Status:\n\n";
            msg += "Using ActiveX: " + (usingActiveX ? "Yes" : "No") + "\n";

            if (usingActiveX) {
                msg += "\nActiveX Controls Loaded:\n";
                msg += "- ATMControl: " + (ATMControl ? "Yes" : "No") + "\n";
                msg += "- GrgApp: " + (GrgApp && GrgApp.activeXObject ? "Yes" : "No") + "\n";
                msg += "- GrgDataPool: " + (GrgDataPool && GrgDataPool.activeXObject ? "Yes" : "No") + "\n";

                if (GrgDataPool) {
                    try {
                        msg += "\nCurrent Card Data:\n";
                        var cardNum = GrgDataPool.GetData("CardNumber");
                        msg += "- Card number: " + (cardNum ? "****" + cardNum.substring(12) : "None") + "\n";
                        var holder = GrgDataPool.GetData("CardholderName");
                        msg += "- Cardholder: " + (holder || "None") + "\n";
                    } catch (e) {
                        msg += "\nError testing GrgDataPool: " + e.message;
                    }
                }
            } else {
                msg += "\nActiveX controls not available.\n";
                msg += "Running in JavaScript simulation mode.\n";
            }

            alert(msg);
        }

        // Initialize AFTER page loads
        window.onload = function () {
            initControls();

            var frame = document.getElementById('stateFrame');
            if (frame) {
                frame.onload = frame.onreadystatechange = function () {
                    try {
                        if (frame.contentWindow) {
                            frame.contentWindow.GetWebCtrl = window.GetWebCtrl;
                            frame.contentWindow.parentWindow = window;
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                };
            }

            // Initialize card display
            updateCardDisplay();

            setTimeout(function () {
                loadState('000');
            }, 100);
        };
    </script>
</head>
<body>
    <div id="container">
        <!-- Left column -->
        <div id="sidePanel">
            <div id="logo">🏦 Universal Bank ATM</div>
            
            <div id="statusIndicator" class="status-indicator">Initializing...</div>
            
            <button class="actionBtn" onclick="insertTestCard()">Insert Card</button>
            <button class="actionBtn secondary" onclick="switchTestCard()">Switch Card</button>
            <button class="actionBtn" onclick="resetSystem()">Reset System</button>
            <button class="actionBtn" onclick="loadState('000')">Back to Start</button>
            
             <!-- DEBUG ACTIVEX CONTROLS -->
             <!-- <button class="actionBtn" onclick="testActiveX()">Test ActiveX</button> -->

            <div id="cardInfo" class="card-info"></div>

            <div id="logArea"></div>
        </div>

        <!-- Right column: the ATM screen -->
        <div id="atmScreen">
            <iframe id="stateFrame" name="stateFrame"></iframe>
        </div>
    </div>
</body>
</html></div>
</body>
</html>
